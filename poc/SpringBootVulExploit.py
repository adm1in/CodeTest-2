import requests
from requests.packages import urllib3
from lib.clasetting import color
from requests import head,get
urllib3.disable_warnings()

HEADER = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:34.0) Gecko/20100101 Firefox/34.0',
          'Accept': '*/*',
          'Connection': 'keep-alive',
          'Accept-Language': 'zh-CN,zh;q=0.8'}

class SpringBootVul():
    SpringV1_validator = []
    SpringV2_validator = []

    @classmethod
    def addSpringV1Validator(cls, func):
        cls.SpringV1_validator.append(func)
        return func

    @classmethod
    def addSpringV2Validator(cls, func):
        cls.SpringV2_validator.append(func)
        return func

@SpringBootVul.addSpringV1Validator
def SpringV1TimeOutValidator(url):
    """ SpringV1检测超时 """
    
    try:
        r = get(url, headers=HEADER, timeout=3, verify=False)
        #r = get(conf.httpUrl, headers=HEADER, proxies=proxies, timeout=conf.verifyTimeout)
        #return True if r.status_code == 200 and ',' not in r.text else False
        return True if r.status_code == 200 else False
    except Exception as e:
        return False


@SpringBootVul.addSpringV2Validator
def SpringV2TimeOutValidator(url):
    """SpringV2检测超时"""
    try:
        r = get(url, headers=HEADER, timeout=3, verify=False)
        #r = get(conf.httpsUrl, headers=HEADER, proxies=proxies, timeout=conf.verifyTimeout, verify=False)
        #return True if r.status_code == 200 and ',' not in r.text else False
        return True if r.status_code == 200 else False
    except Exception as e:
        return False

#敏感信息路径查找
Spring2_path_list = ['/actuator','/actuator/auditevents','/actuator/beans','/actuator/conditions','/actuator/configprops','/actuator/env','/actuator/trace','/actuator/health','/actuator/logfile','/actuator/httptrace','/actuator/info','/actuator/jolokia','/actuator/loggers','/actuator/mappings','/actuator/metrics','/actuator/scheduledtasks','/actuator/threaddump','/actuator/swagger-ui.html','/auditevents','/autoconfig','/eureka','/beans','/cloudfoundryapplication','/configprops','/dump','/druid/login.html','/entity/all','/swagger/swagger-ui.html','/api/swagger-ui.html','/swagger/index.html','/v1.1/swagger-ui.html','/v1.2/swagger-ui.html','/v1.3/swagger-ui.html','/v1.4/swagger-ui.html','/v1.5/swagger-ui.html','/v1.6/swagger-ui.html','/v1.7/swagger-ui.html','/v1.8/swagger-ui.html','/v1.9/swagger-ui.html','/v2.0/swagger-ui.html','/v2.1/swagger-ui.html','/v2.2/swagger-ui.html','/v2.3/swagger-ui.html','/%20/swagger-ui.html','/logfile','/env','/env/(name)','/health','/heapdump','/hystrix','/hystrix.stream','/info','/webpage/system/druid/index.html','/system/druid/index.html','/druid/index.html','/druid/websession.html','/jolokia','/jolokia/list','/loggers','/mappings','/metrics','/monitor','/swagger-ui.html','/threaddump','/trace','/gateway/actuator','/gateway/actuator/auditevents','/gateway/actuator/beans','/gateway/actuator/conditions','/gateway/actuator/configprops','/gateway/actuator/env','/gateway/actuator/trace','/gateway/actuator/health','/gateway/actuator/logfile','/gateway/actuator/heapdump','/gateway/actuator/httptrace','/gateway/actuator/hystrix.stream','/gateway/actuator/info','/gateway/actuator/jolokia','/gateway/actuator/loggers','/gateway/actuator/mappings','/gateway/actuator/metrics','/gateway/actuator/scheduledtasks','/gateway/actuator/threaddump','/gateway/actuator/swagger-ui.html','/api-docs','/v2/api-docs','/api.html','/sw/swagger-ui.html','/template/swagger-ui.html','/spring-security-rest/api/swagger-ui.html','/spring-security-oauth-resource/swagger-ui.html','/caches','/conditions','/docs','/flyway','/httptrace','/intergrationgraph','/liquibase','/prometheus','/refresh','/scheduledtasks','/sessions','/shutdown']
#Fck_path_list = ['/editor/dialog/fck_about.html','/_whatsnew.html','/editor/filemanager/browser/default/connectors/test.html','/editor/filemanager/upload/test.html','/editor/filemanager/connectors/test.html','/editor/filemanager/connectors/uploadtest.html','/_samples/default.html','/_samples/asp/sample01.asp','/_samples/asp/sample02.asp','/_samples/asp/sample03.asp','/_samples/asp/sample04.asp','/editor/.htm','/editor/fckdialog.html','/editor/filemanager/browser/default/connectors/asp/connector.asp?Command=GetFoldersAndFiles&Type=Image&CurrentFolder=/','/editor/filemanager/browser/default/connectors/php/connector.php?Command=GetFoldersAndFiles&Type=Image&CurrentFolder=/','/editor/filemanager/browser/default/connectors/aspx/connector.aspx?Command=GetFoldersAndFiles&Type=Image&CurrentFolder=/','/editor/filemanager/browser/default/connectors/jsp/connector.jsp?Command=GetFoldersAndFiles&Type=Image&CurrentFolder=/','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=http://www.site.com//editor/filemanager/connectors/php/connector.php','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=http://www.site.com//editor/filemanager/connectors/asp/connector.asp','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=http://www.site.com//editor/filemanager/connectors/aspx/connector.aspx','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=http://www.site.com//editor/filemanager/connectors/jsp/connector.jsp','/editor/filemanager/browser/default/browser.html?type=Image&connector=connectors/asp/connector.asp','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/jsp/connector.jsp','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/aspx/connector.Aspx','/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/php/connector.php','/editor/filemanager/connectors/asp/connector.asp?Command=CreateFolder&Type=File&CurrentFolder=/shell.asp&NewFolderName=z.asp','/editor/filemanager/connectors/asp/connector.asp?Command=CreateFolder&Type=Image&CurrentFolder=/shell.asp&NewFolderName=z&uuid=1244789975684','/editor/filemanager/browser/default/connectors/asp/connector.asp?Command=CreateFolder&CurrentFolder=/&Type=Image&NewFolderName=shell.asp','/editor/filemanager/browser/default/connectors/aspx/connector.aspx?Command=CreateFolder&Type=Image&CurrentFolder=../../../&NewFolderName=shell.asp','/editor/filemanager/browser/default/connectors/aspx/connector.aspx?Command=GetFoldersAndFiles&Type=Image&CurrentFolder=e:/']
#Vul_path_list = Spring_path_list+Fck_path_list

Spring1_path_list = ['/env','/refresh','/restart','/jolokia','/httptrace','/heapdump','/h2-console']
Spring23_path_list = ['/actuator/env','/actuator/refresh','/actuator/restart','/actuator/jolokia','/actuator/httptrace','/actuator/heapdump','h2-console']
VUL_LIST = []

"""
:查找spring敏感路径泄露信息
"""
def check(**kwargs):
    try:
        urls = kwargs['url'].strip('/')
                
        for func in SpringBootVul.SpringV1_validator:
            for path in Spring1_path_list:
                if func(urls+path):
                    VUL_LIST.append(path)
                    color('[+] %s %s'%(urls+path,200),'green')
                    
        for func in SpringBootVul.SpringV2_validator:
            for path in Spring2_path_list:
                if func(urls+path):
                    VUL_LIST.append(path)
                    color('[+] %s %s'%(urls+path,200),'green')
        for i in VUL_LIST:
            print(i)
        for vul_path in VUL_LIST:
            if '/env' in vul_path:
                print('0x02：spring cloud SnakeYAML RCE')
                print('0x03：eureka xstream deserialization RCE')
                print('0x06：h2 database query RCE')
                print('0x08：mysql jdbc deserialization RCE')

            if '/jolokia' in vul_path:
                print('0x04：jolokia logback JNDI RCE')
                print('0x05：jolokia Realm JNDI RCE')

            if '/h2-console' in vul_path:
                print('0x07：h2 database console JNDI RCE')

            if '/heapdump' in vul_path:
                print('0x06：获取被星号脱敏的密码的明文 (方法四): https://landgrey.me/blog/16/')

        print('[*] 更多相关漏洞信息, 请参阅: https://github.com/LandGrey/SpringBootVulExploit')
        #print(VUL_LIST)
    except Exception as e:
        print('脚本执行出错 %s'%e)

if __name__ == "__main__":
    a = check(**{'url':'http://107.186.204.163:9999'})